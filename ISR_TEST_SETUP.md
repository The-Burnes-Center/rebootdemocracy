# ISR Test Setup - Simple Example

This is a minimal setup to test ISR (Incremental Static Regeneration) with Nuxt 4 on Netlify.

## What's Included

1. **Simple API Endpoint** (`/api/test-isr`)
   - Returns a timestamp that changes on each request
   - No external dependencies (no Directus)

2. **Test Page** (`/test-isr`)
   - Uses ISR with 1 hour cache (3600 seconds)
   - Displays data from the API
   - Shows how ISR works

## How to Test Locally

1. **Start the dev server:**
   ```bash
   npm run dev
   ```

2. **Visit the test page:**
   ```
   http://localhost:3000/test-isr
   ```

3. **Test ISR behavior:**
   - First request: Page is generated by serverless function
   - Subsequent requests: Should be served from cache (timestamp won't change immediately)
   - After 1 hour: Page regenerates on next request
   - **On-demand revalidation:** Click "Revalidate Cache" button to immediately regenerate

## How ISR Works

1. **Initial Build**: Page is NOT prerendered (it uses ISR)
2. **First Request**: Page is generated by serverless function (Nuxt Nitro) and cached at CDN edge
3. **Subsequent Requests**: Served from CDN cache (fast!)
4. **After Cache Expires (1 hour)**: Page regenerates on next request via serverless function
5. **On-Demand Revalidation**: Call `/api/test-isr/revalidate` to immediately purge cache and regenerate
6. **Only This Page Regenerates**: Not the entire site

## On-Demand Revalidation

The test page includes a "Revalidate Cache" button that:
1. Calls `/api/test-isr/revalidate` endpoint
2. Purges the CDN cache for `/test-isr` page
3. Reloads the page to show regenerated content with new timestamp

**Note:** On-demand revalidation requires `NETLIFY_AUTH_TOKEN` environment variable in production.

## Configuration

### `nuxt.config.ts`
```typescript
routeRules: {
  '/test-isr': { 
    isr: 3600,  // ISR: Regenerate every hour
  },
}
```

### `netlify.toml`
```toml
[build]
command = "npm run build"
publish = ".output/public"

[functions]
directory = ".output/server"

[[redirects]]
from = "/*"
to = "/.netlify/functions/server"
status = 200

[[headers]]
for = "/test-isr"
[headers.values]
Cache-Control = "public, s-maxage=3600, stale-while-revalidate=86400"
```

## Testing on Netlify

1. **Deploy to Netlify:**
   - Push to your repository
   - Netlify will automatically build and deploy

2. **Test the ISR page:**
   - Visit: `https://your-site.netlify.app/test-isr`
   - First request: Page is generated (check timestamp)
   - Refresh immediately: Should see same timestamp (served from cache)
   - Wait 1 hour or purge cache: Next request regenerates page

3. **Check the timestamp:**
   - The timestamp should change after cache expires
   - This proves ISR is working

## Expected Behavior

- ✅ First request generates the page
- ✅ Subsequent requests are served from cache (same timestamp)
- ✅ After 1 hour, next request regenerates (new timestamp)
- ✅ Only this page regenerates, not the entire site

## Troubleshooting

If you see errors about `file://` imports:
- This is a known issue with Nitro's Netlify preset
- The `server.mjs` file has `nodeBundler: "none"` which should prevent bundling
- If Netlify still tries to bundle, we may need to adjust the configuration

## Next Steps

Once this simple test works, you can:
1. Apply the same ISR setup to your blog posts
2. Add cache purging webhooks for on-demand revalidation
3. Monitor cache hit rates and performance

