# ISR Test Setup - Simple Example

This is a minimal setup to test ISR (Incremental Static Regeneration) with Nuxt 4 on Netlify.

## What's Included

1. **Simple API Endpoint** (`/api/test-isr`)
   - Returns a timestamp that changes on each request
   - No external dependencies (no Directus)

2. **Test Page** (`/test-isr`)
   - Uses ISR with 1 hour cache (3600 seconds)
   - Displays data from the API
   - Shows how ISR works

## How to Test Locally

1. **Start the dev server:**
   ```bash
   npm run dev
   ```

2. **Visit the test page:**
   ```
   http://localhost:3000/test-isr
   ```

3. **Test ISR behavior:**
   - First request: Page is generated by serverless function
   - Subsequent requests: Should be served from cache (timestamp won't change immediately)
   - After 1 hour: Page regenerates on next request
   - **On-demand revalidation:** Click "Revalidate Cache" button to immediately regenerate

## How ISR Works

1. **Initial Build**: Page is NOT prerendered (it uses ISR)
2. **First Request**: Page is generated by serverless function (Nuxt Nitro) and cached at CDN edge
3. **Subsequent Requests**: Served from CDN cache (fast!)
4. **After Cache Expires (1 hour)**: Page regenerates on next request via serverless function
5. **On-Demand Revalidation**: Call `/api/test-isr/revalidate` to immediately purge cache and regenerate
6. **Only This Page Regenerates**: Not the entire site

## On-Demand Revalidation

The test page includes a "Revalidate Cache" button that:
1. Calls `/api/test-isr/revalidate` endpoint
2. Purges the CDN cache for `/test-isr` page
3. Reloads the page to show regenerated content with new timestamp

**Note:** On-demand revalidation requires `NETLIFY_AUTH_TOKEN` environment variable in production.

## Configuration

### `nuxt.config.ts`
```typescript
routeRules: {
  '/test-isr': { 
    isr: 3600,  // ISR: Regenerate every hour
  },
}
```

### `netlify.toml`
```toml
[build]
command = "npm run build"
publish = ".output/public"

[functions]
directory = ".output/server"

[[redirects]]
from = "/*"
to = "/.netlify/functions/server"
status = 200

[[headers]]
for = "/test-isr"
[headers.values]
Cache-Control = "public, s-maxage=3600, stale-while-revalidate=86400"
```

## Testing on Netlify (Production)

1. **Deploy to Netlify:**
   ```bash
   git push origin your-branch-name
   ```
   Or deploy via Netlify UI.

2. **Visit the test page:**
   ```
   https://your-branch-name--burnesblogtemplate.netlify.app/test-isr
   ```
   Or your main site URL if deploying to production.

3. **Test ISR behavior:**
   - **First visit:** Page is generated by serverless function (may take 1-2 seconds)
   - **Immediate refresh:** Should be served from CDN cache (fast, same timestamp)
   - **After 1 hour:** Next request regenerates the page (new timestamp)
   - **On-demand revalidation:** Click "Revalidate Cache" button to immediately purge cache and regenerate

4. **Test revalidation endpoint directly:**
   ```bash
   curl -X POST https://your-branch-name--burnesblogtemplate.netlify.app/api/test-isr/revalidate \
     -H "Content-Type: application/json"
   ```
   
   Expected response:
   ```json
   {
     "success": true,
     "message": "Cache purged successfully - next request will regenerate the page",
     "purged": true,
     "timestamp": "2025-01-08T12:00:00.000Z"
   }
   ```

5. **Verify cache purge worked:**
   - After clicking "Revalidate Cache" or calling the endpoint
   - Refresh the `/test-isr` page
   - The timestamp should change (indicating a new page was generated)

6. **Check Netlify function logs:**
   ```bash
   netlify logs:function --name server
   ```
   Or view logs in Netlify Dashboard → Functions → server → Logs

## Expected Behavior

- ✅ First request generates the page
- ✅ Subsequent requests are served from cache (same timestamp)
- ✅ After 1 hour, next request regenerates (new timestamp)
- ✅ Only this page regenerates, not the entire site

## Troubleshooting

If you see errors about `file://` imports:
- This is a known issue with Nitro's Netlify preset
- The `server.mjs` file has `nodeBundler: "none"` which should prevent bundling
- If Netlify still tries to bundle, we may need to adjust the configuration

## Next Steps

Once this simple test works, you can:
1. Apply the same ISR setup to your blog posts
2. Add cache purging webhooks for on-demand revalidation
3. Monitor cache hit rates and performance

