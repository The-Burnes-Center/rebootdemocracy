[build]
# Use 'build' instead of 'generate' for ISR support
# 'build' creates the server handler that includes server/api/ routes
# 'generate' only creates static files and doesn't build server routes
command = "rm -rf .output .nuxt .netlify && npm ci && npm run build"
# With netlify preset:
# - Public files are in .output/public (static assets and prerendered pages)
# - Server handler is in .netlify/functions-internal/server (auto-detected, includes server/api/ routes)
#   This shows up as "server handler" (system) in Netlify Functions
# - Custom functions are in netlify/functions (auto-detected)
publish = ".output/public"
# CRITICAL: Don't set 'functions' here - it prevents Netlify from detecting the server handler
# Netlify will auto-detect:
# 1. Server handler from .netlify/functions-internal/server (includes server/api/ routes) - shows as "server handler"
# 2. Custom functions from netlify/functions (if directory exists)
# NOTE: Cache warm-up is handled via /api/warm-cache endpoint
# - After deploy: Netlify webhook calls POST /api/warm-cache (full warm-up)
# - After revalidation: /api/revalidate calls POST /api/warm-cache with tag (single page warm-up)

[build.environment]
  NODE_VERSION = "20.12.2"
  NPM_VERSION = "10.8.0"
  NPM_FLAGS = "--no-audit --no-fund --verbose"
  NETLIFY_BUILD_DEBUG = "true"

# NOTE: We're NOT setting [functions] directory here because:
# - Setting it prevents Netlify from auto-detecting the server handler
# - The server handler (with server/api/ routes) is in .output/server
# - Custom functions in netlify/functions will still be detected automatically
# If you need custom function settings, uncomment below but be aware it may affect server handler detection:
[functions]
  node_bundler = "esbuild"
  external_node_modules = ["@directus/sdk", "jstoxml", "he", "jsdom"]

# NOTE: Removed catch-all redirect "/*" -> "/index.html"
# This was interfering with ISR routes - the server handler needs to process blog routes
# Nuxt handles routing internally, so we don't need this SPA-style redirect

# NOTE: Removed "/api/*" redirect to "/.netlify/functions/:splat"
# The server handler (from .netlify/functions-internal/server) handles /api/* routes directly
# The redirect was trying to send /api/revalidate to /.netlify/functions/revalidate
# but revalidate is part of the server handler, not a standalone function

[[redirects]]
from = "/newsoftheweek/feed/rss"
to = "/.netlify/functions/newsoftheweek"
status = 200
force = true

[dev]
command = "npm run dev"
targetPort = 3000

[images]
remote_images = ["https://burnes-center.directus.app/assets/.*"]

[[headers]]
  for = "/"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.html"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/blog"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/blog/*"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/_nuxt/*.js"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"
  
[[headers]]
  for = "/*.css"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/images/*"
  [headers.values]
    cache-control = "public, max-age=2592000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.json"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

# CACHE for fonts (1 year - fonts rarely change)
[[headers]]
  for = "/*.woff"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.woff2"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.ttf"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.eot"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[functions.scheduled-build]
schedule = "0 */12 * * *"