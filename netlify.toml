[build]
command = "rm -rf .nuxt && npm ci && npm run generate"
publish = ".output/public/"
functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20.12.2"
  NPM_VERSION = "10.8.0"
  NPM_FLAGS = "--no-audit --no-fund --verbose"
  NETLIFY_BUILD_DEBUG = "true"

# ISR (Incremental Static Regeneration) with cache tags configuration
# Blog posts use ISR for on-demand regeneration:
# 1. Initial build: Pages are NOT prerendered (they're generated on first request)
# 2. First request: Page is generated by serverless function (Nuxt Nitro) and cached at CDN edge
# 3. Content update: Webhook at /api/blog/revalidate purges cache for specific page
# 4. Next request: Page regenerates via serverless function (not a full build)
# 5. Only the specific page regenerates, metadata (title, etc.) updates automatically
# 
# Note: For initial SEO, consider running a warm-up script after deployment
# to generate all blog posts on first request (see scripts/warm-up-blog-posts.ts)

[functions]
  node_bundler = "esbuild"
  external_node_modules = ["@directus/sdk", "jstoxml", "he", "jsdom"]
  directory = "netlify/functions"

# API routes are handled by Nuxt Nitro server
# IMPORTANT: /api/* routes must be handled BEFORE the catch-all redirect
# With nitro.preset: 'netlify', Nitro creates a serverless function that handles all server routes
# The function is typically at /.netlify/functions/server (not nitro)
# We need to pass the full path including /api to the function
[[redirects]]
from = "/api/*"
to = "/.netlify/functions/server/api/:splat"
status = 200
force = true

# Catch-all for non-prerendered routes (should come AFTER /api/* redirect)
# Netlify will serve static files (like prerendered blog posts) before applying this redirect
# This catch-all should NOT catch /api/* routes (handled above)
[[redirects]]
from = "/*"
to = "/index.html"
status = 200

[[redirects]]
from = "/newsoftheweek/feed/rss"
to = "/.netlify/functions/newsoftheweek"
status = 200
force = true

[dev]
command = "npm run dev"
targetPort = 3000

[images]
remote_images = ["https://burnes-center.directus.app/assets/.*"]

[[headers]]
  for = "/"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.html"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/blog"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/blog/*"
  [headers.values]
    # ISR pages: Browser should revalidate, but CDN caches with Netlify-CDN-Cache-Control
    # Set by Nuxt ISR route rules - no need to override here
    access-control-allow-origin = "*"

[[headers]]
  for = "/_nuxt/*.js"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"
  
[[headers]]
  for = "/*.css"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

[[headers]]
  for = "/images/*"
  [headers.values]
    cache-control = "public, max-age=2592000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.json"
  [headers.values]
    cache-control = "no-cache, no-store, must-revalidate"
    pragma = "no-cache"
    expires = "0"
    access-control-allow-origin = "*"

# CACHE for fonts (1 year - fonts rarely change)
[[headers]]
  for = "/*.woff"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.woff2"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.ttf"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[[headers]]
  for = "/*.eot"
  [headers.values]
    cache-control = "public, max-age=31536000, immutable"
    access-control-allow-origin = "*"

[functions.scheduled-build]
schedule = "0 */12 * * *"

# Warm-up function for ISR blog posts
# RECOMMENDED: Use Netlify Deploy Notifications to trigger automatically after each deployment
# See WARM_UP_SETUP.md for step-by-step setup instructions
# 
# Alternative: Scheduled function (runs every hour as backup)
[functions.warm-up-blog-posts]
schedule = "0 * * * *"  # Runs every hour (backup option)
# Note: Deploy Notifications is preferred - runs immediately after deployment